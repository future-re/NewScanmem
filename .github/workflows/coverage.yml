name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  coverage:
    name: Generate Coverage Report and Publish Docs
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/future-re/ubuntu22.04-clang20-boost1.89-gtest1.17:0.2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            llvm-20 \
            clang-20 \
            cmake \
            ninja-build \
            libicu-dev \
            libboost-all-dev \
            python3-venv \
            python3-pip
          
          # Create symlinks for llvm tools
          sudo update-alternatives --install /usr/bin/llvm-cov llvm-cov /usr/bin/llvm-cov-20 100
          sudo update-alternatives --install /usr/bin/llvm-profdata llvm-profdata /usr/bin/llvm-profdata-20 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 100

      - name: Configure CMake with Coverage
        run: |
          cmake -B build \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DENABLE_COVERAGE=ON \
            -DCMAKE_CXX_COMPILER=clang++-20

      - name: Build project
        run: cmake --build build --parallel

      - name: Run tests
        run: |
          cd build
          LLVM_PROFILE_FILE="test/%p.profraw" ctest --output-on-failure --parallel

      - name: Generate coverage report
        run: ./generate_coverage.sh --all

      - name: Coverage summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat build/coverage/summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: build/coverage/html/
          retention-days: 30

      - name: Upload LCOV coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: build/coverage/coverage.lcov
          retention-days: 30

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: build/coverage/coverage.lcov
          flags: unittests
          name: codecov-newscanmem
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage thresholds
        run: ./generate_coverage.sh --check
        continue-on-error: true

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('build/coverage/summary.txt', 'utf8');
            
            const comment = `## ðŸ“Š Coverage Report
            
            ```
            ${summary}
            ```
            
            [View detailed HTML report in workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # Build MkDocs site and publish to GitHub Pages
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install MkDocs and theme
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-static-i18n

      - name: Build MkDocs site
        run: |
          ./mkdocs/scripts/copy_coverage_html.sh || true
          cd mkdocs
          mkdocs build -d site

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: mkdocs/site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1
name: Code Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/future-re/ubuntu22.04-clang20-boost1.89-gtest1.17:0.2
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies
        name: Code Coverage

        on:
          push:
            branches: [ main, develop ]
          pull_request:
            branches: [ main, develop ]

        permissions:
          contents: read
          pages: write
          id-token: write

        jobs:
          coverage:
            name: Generate Coverage Report and Publish Docs
            runs-on: ubuntu-24.04
            container:
              image: ghcr.io/future-re/ubuntu22.04-clang20-boost1.89-gtest1.17:0.2

            steps:
              - name: Checkout code
                uses: actions/checkout@v4
                with:
                  submodules: recursive

              - name: Install dependencies
                run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    llvm-20 \
                    clang-20 \
                    cmake \
                    ninja-build \
                    libicu-dev \
                    libboost-all-dev \
                    python3-venv \
                    python3-pip
          
                  # Create symlinks for llvm tools
                  sudo update-alternatives --install /usr/bin/llvm-cov llvm-cov /usr/bin/llvm-cov-20 100
                  sudo update-alternatives --install /usr/bin/llvm-profdata llvm-profdata /usr/bin/llvm-profdata-20 100
                  sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 100

              - name: Configure CMake with Coverage
                run: |
                  cmake -B build \
                    -GNinja \
                    -DCMAKE_BUILD_TYPE=Debug \
                    -DENABLE_COVERAGE=ON \
                    -DCMAKE_CXX_COMPILER=clang++-20

              - name: Build project
                run: cmake --build build --parallel

              - name: Run tests
                run: |
                  cd build
                  LLVM_PROFILE_FILE="test/%p.profraw" ctest --output-on-failure --parallel

              - name: Generate coverage report
                run: ./generate_coverage.sh --all

              - name: Coverage summary
                run: |
                  echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  cat build/coverage/summary.txt >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY

              - name: Upload HTML coverage report
                uses: actions/upload-artifact@v4
                with:
                  name: coverage-report-html
                  path: build/coverage/html/
                  retention-days: 30

              - name: Upload LCOV coverage
                uses: actions/upload-artifact@v4
                with:
                  name: coverage-lcov
                  path: build/coverage/coverage.lcov
                  retention-days: 30

              # Optional: Upload to Codecov
              - name: Upload to Codecov
                uses: codecov/codecov-action@v4
                with:
                  files: build/coverage/coverage.lcov
                  flags: unittests
                  name: codecov-newscanmem
                  fail_ci_if_error: false
                env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

              # Optional: Check coverage thresholds (will fail PR if below minimum)
              - name: Check coverage thresholds
                run: ./generate_coverage.sh --check
                continue-on-error: true

              # Optional: Comment PR with coverage info
              - name: Comment PR with coverage
                if: github.event_name == 'pull_request'
                uses: actions/github-script@v7
                with:
                  script: |
                    const fs = require('fs');
                    const summary = fs.readFileSync('build/coverage/summary.txt', 'utf8');
            
                    const comment = `## ðŸ“Š Coverage Report
            
                    ```
                    ${summary}
                    ```
            
                    [View detailed HTML report in workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
                    `;
            
                    github.rest.issues.createComment({
                      issue_number: context.issue.number,
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      body: comment
                    });

              # --- Build MkDocs site and publish to GitHub Pages ---
              - name: Setup Python
                uses: actions/setup-python@v4
                with:
                  python-version: '3.x'

              - name: Install MkDocs and theme
                run: |
                  python -m pip install --upgrade pip
                  pip install mkdocs mkdocs-material

              - name: Build MkDocs site
                run: |
                  ./mkdocs/scripts/copy_coverage_html.sh || true
                  cd mkdocs
                  mkdocs build -d site

              - name: Upload site artifact
                uses: actions/upload-pages-artifact@v1
                with:
                  path: mkdocs/site

              - name: Deploy to GitHub Pages
                uses: actions/deploy-pages@v1
