name: Code Coverage

on:
  workflow_run:
    workflows: ["CI Workflow"]
    types: [completed]
  push:
    branches: [ main ]
  workflow_dispatch: {}
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  coverage:
    name: Generate Coverage Report and Publish Docs
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/future-re/ubuntu22.04-clang20-boost1.89-gtest1.17:0.2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set Docker image tag env
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "DOCKER_IMAGE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Try download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output-coverage
          path: build-output
        continue-on-error: true

      - name: Try download linux build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output-ubuntu-22.04
          path: build-output
        continue-on-error: true

      - name: Restore build (if present)
        run: |
          if [ -d build-output/build ]; then
            mv build-output/build .
          fi

      - name: Ensure dependencies (only if we must build locally)
        run: |
          if [ ! -f build/coverage/summary.txt ]; then
            sudo apt-get update
            sudo apt-get install -y \
              llvm-20 \
              clang-20 \
              cmake \
              ninja-build \
              libicu-dev \
              libboost-all-dev \
              python3-venv \
              python3-pip
          else
            echo "Coverage summary already present in artifact; skipping dependency install."
          fi

      - name: Generate coverage report (use artifact if available)
        run: |
          if [ -f build/coverage/summary.txt ]; then
            echo "Coverage summary already produced by build artifact."
          else
            echo "No coverage summary found in artifact; configuring, building and running tests locally."
            cmake -B build \
              -GNinja \
              -DCMAKE_BUILD_TYPE=Debug \
              -DENABLE_COVERAGE=ON \
              -DCMAKE_CXX_COMPILER=clang++-20
            cmake --build build --parallel
            cd build
            LLVM_PROFILE_FILE="test/%p.profraw" ctest --output-on-failure --parallel
            cd ..
            ./generate_coverage.sh --all
          fi

      - name: Coverage summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat build/coverage/summary.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-html
          path: build/coverage/html/
          retention-days: 30

      - name: Upload LCOV coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: build/coverage/coverage.lcov
          retention-days: 30

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: build/coverage/coverage.lcov
          flags: unittests
          name: codecov-newscanmem
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Check coverage thresholds
        run: ./generate_coverage.sh --check
        continue-on-error: true

      - name: Comment PR with coverage
        if: github.event.pull_request != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('build/coverage/summary.txt', 'utf8');
  
            const comment = `## ðŸ“Š Coverage Report
  
            ```
            ${summary}
            ```
  
            [View detailed HTML report in workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
  
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install MkDocs and theme
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-static-i18n

      - name: Build MkDocs site
        run: |
          ./mkdocs/scripts/copy_coverage_html.sh || true
          cd mkdocs
          mkdocs build -d site

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: mkdocs/site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1
