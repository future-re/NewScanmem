name: Publish Docker Image

on:
  push:
    tags:
      - 'v*.*.*'        # push tag 时发布
  workflow_dispatch: {} # 或手动触发

permissions:
  contents: write
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine if Dockerfile changed and compute new tag
        id: taginfo
        run: |
          set -euo pipefail
          # fetch tags already done by checkout with fetch-depth=0
          LAST_TAG=$(git describe --tags --match "v[0-9]*" --abbrev=0 2>/dev/null || echo "")
          echo "LAST_TAG=${LAST_TAG}"
          if [ -z "$LAST_TAG" ]; then
            # default base if no tag exists
            MAJOR=0; MINOR=0; PATCH=2
          else
            # strip leading v
            VER=${LAST_TAG#v}
            MAJOR=$(echo "$VER" | cut -d. -f1)
            MINOR=$(echo "$VER" | cut -d. -f2)
            PATCH=$(echo "$VER" | cut -d. -f3)
          fi

          # check if Dockerfile changed since last tag (or always changed if no last tag)
          if [ -z "$LAST_TAG" ]; then
            CHANGED=1
          else
            if git diff --name-only "$LAST_TAG" HEAD -- Dockerfile | grep -q Dockerfile; then
              CHANGED=1
            else
              CHANGED=0
            fi
          fi

          if [ "$CHANGED" -eq 0 ]; then
            echo "Dockerfile not changed since $LAST_TAG; skipping image publish." >&2
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # bump patch
          PATCH=$((PATCH + 1))
          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_tag=${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "NEW_TAG=${NEW_TAG}"

      - name: Create and push git tag
        if: steps.taginfo.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          NEW_TAG=${{ steps.taginfo.outputs.new_tag }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          # push tag using token auth
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" refs/tags/$NEW_TAG


      - name: Set up QEMU
        if: steps.taginfo.outputs.changed == 'true'
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        if: steps.taginfo.outputs.changed == 'true'
        uses: docker/setup-buildx-action@v2

      - name: Login to GHCR
        if: steps.taginfo.outputs.changed == 'true'
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        if: steps.taginfo.outputs.changed == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/future-re/ubuntu22.04-clang20-boost1.89-gtest1.17:${{ steps.taginfo.outputs.new_tag }}
            ghcr.io/future-re/ubuntu22.04-clang20-boost1.89-gtest1.17:latest
          platforms: linux/amd64